<link rel="stylesheet" href="~/Content/bootstrap-table.css">
<script src="~/Content/bootstrap-table.js"></script>

<input type="hidden" id="orderId" name="orderId" value="" />
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">更新订单状态</h4>
            </div>
            <div class="modal-body">
                <button class="btn statusClass" data-id="1">已下单</button>
                <button class="btn statusClass" data-id="2">已发货</button>
                <button class="btn statusClass" data-id="3">已付款</button>
                <button class="btn statusClass" data-id="4">已完成</button>
                <button class="btn statusClass" data-id="5">其他</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="btnUpdate" class="btn btn-primary">提交更改</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

@*<section class="content">
        <table id="example" class="display" ></table>
    </section>*@
<div class="panel panel-default">
    <div class="row">
        <div class="col-sm-3">
            <label> 订单号</label>
            <input id="txtorderno" value="" />
        </div>
        <div class="col-sm-3">
            <label> 手机号</label>
            <input id="txtphone" value="" />
        </div>
        <div class="col-sm-3">
            <label> 姓名</label>
            <input id="txtname" value="" />
        </div>
    </div>

    <div class="row">
        <div class="col-sm-3">
            <label> 商品名</label>
            <input id="txtproname" value="" />
        </div>
        <div class="col-sm-3">
            <label> 状态</label>
            <input id="txtstatus" value="" />
        </div>
        <div class="col-sm-3">
            <label> 地址</label>
            <input id="txtaddress" value="" />
        </div>
        <div class="col-sm-3">
            <button id="btnquery" type="button" class="btn btn-default">查询</button>
        </div>

    </div>


</div>

<div class="content">
    <table id="example" class="display"></table>
</div>

<script>

    $("#btnquery").click(function () {
        debugger;
        // public string OrderNo { get; set; }
        //public string ReceivePhone { get; set; }
        //public string ReceiveName { get; set; }
        //public string ProductName { get; set; }
        //public string Status { get; set; }
        //public string Address { get; set; }

        var param = {};
        param.OrderNo = $("#txtorderno").val();
        param.ReceivePhone = $("#txtphone").val();
        param.ReceiveName = $("#txtname").val();
        param.ProductName = $("#txtproname").val();
        param.Status = $("#txtstatus").val();
        param.Address = $("#txtaddress").val();
        $.ajax({
            url: "GetOrderList",
            dataType: "json", data: param,
            success: function (data) {
                $('#example').bootstrapTable('load', data.rows);
                BindTableBtnEvent();
                debugger;
            },
            error: function (e) {
                debugger;
            }
        });
    });
    $(document).ready(function () {
        $('#example').bootstrapTable({
            pagination: true,
            sidePagination: "client",
            pageNumber: 1,
            pageSize: 10,
            pageList: [10, 25, 50, 100],
            columns: [{
                checkbox: true
            }, {
                field: 'number',
                title: '序号',
                width: 5,
                align: 'center',
                switchable: false,
                formatter: function (value, row, index) {
                    //return index+1; //序号正序排序从1开始
                    var pageSize = $('#example').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
                    var pageNumber = $('#example').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
                    return pageSize * (pageNumber - 1) + index + 1;    //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
                }
            }, {
                field: 'ID',
                title: '订单号'
            }, {
                field: 'ProductName',
                title: '商品名称'
            },{
                field: 'Count',
                title: '数量'
            }, {
                field: 'TotalPrice',
                title: '总价'
            }, {
                field: 'ReceiveName',
                title: '姓名'
            }, {
                field: 'ReceivePhone',
                title: '手机号'
            },{
                field: 'CreateTime',
                title: '创建时间', formatter: function (value, row, index) {

                    return timestampToTime(value);
                }
            }, {
                field: 'Status',
                title: '订单状态',
                formatter: function (value, row, index) {

                    return GetStatusDesc(value);
                }
            }, {
                field: 'ID',
                title: '操作',
                formatter: function (value, row, index) {
                    var status = '<button data-id=' + value + ' data-status=' + row.Status + ' data-toggle="modal" data-target="#myModal"' +
                        'class = "updateStatus btn btn-default">更新状态</button > ';
                    var edit = '<button data-id=' + value + ' data-status=' + row.Status +
                        'class = "detail btn btn-default">详情</button > ';
                    return status + edit;
                }
            }]
        });

        $("#btnUpdate").click(function () {

            var id = $("#orderId").val();
            var status = 0;
            $($(".modal-body")[0].children).each(function (index, item) {

                if (item.className.indexOf('btn-danger') > -1) {

                    status = item.dataset.id;
                    return;
                }
            });

            var param = {};
            param.status = status;
            param.orderId = id;
            $.ajax({
                url: "UpdateOrderStatus",
                data: param,
                type: "post",
                dataType: "json",
                success: function (result) {

                    alert("操作成功")
                    window.location.reload();
                }, error: function (ex) {

                }
            });
        });

        $(".statusClass").click(function () {

            var self = this;
            var modelClass = $(this.parentElement.children).each(function (index, item) {

                $(item).removeClass();
                if (self == item) {
                    $(item).addClass("btn statusClass btn-lg btn-danger");
                } else {
                    $(item).addClass("btn statusClass");
                }
            });
        });
    });

    function BindTableBtnEvent() {
        $(".updateStatus").click(function () {

            var self = this;
            $("#orderId").val(this.dataset.id);
            $("#status").val(this.dataset.status);
            $($(".modal-body")[0].children).each(function (index, item) {

                if (item.dataset.id == self.dataset.status) {

                    $(item).removeClass();
                    $(item).addClass("btn statusClass btn-lg btn-danger");
                    return;
                }
            });
        });
    }

    function GetStatusDesc(status) {

        //订单状态 1:已下单  2:已发货  3:已付款  4:已完成  5:其他
        var statusDesc = '未知';
        switch (status) {
            case 1: statusDesc = "已下单";
                break;
            case 2: statusDesc = "已发货";
                break;
            case 3: statusDesc = "已付款";
                break;
            case 4: statusDesc = "已完成";
                break;
            case 5: statusDesc = "其他";
                break;
            default: statusDesc = "未知";
                break;
        }
        return statusDesc;
    }

    function timestampToTime(timestamp) {

        var date = new Date(parseInt(timestamp.replace("/Date(", "").replace(")/", ""), 10));
        Y = date.getFullYear() + '-';
        M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
        D = (date.getDate() < 10 ? "0" + date.getDate() : date.getDate()) + ' ';
        h = (date.getHours() < 10 ? "0" + date.getHours() : date.getHours()) + ':';
        m = (date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes()) + ':';
        s = (date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds());
        return Y + M + D + h + m + s;
    }
</script>
